!function(e){const t=/^ws:/i,n={};function r(e,t={}){const n=e.replace(/^ws:/i,"ws://"),r=$({}),o=Object.assign({reconnect:!0,maxRetries:1/0,reconnectDelay:1e3,maxReconnectDelay:3e4,reconnectBackoffFactor:1.5,reconnectJitter:.5,autoJson:!0,heartbeatInterval:15e3,heartbeatMessage:"ping",connectionTimeout:5e3,maxQueueSize:100,rateLimitInterval:50,debug:!1,inactivityTimeout:6e4,batchInterval:50,disableAutoJson:!1,protocols:void 0,sendTimeout:5e3,adaptiveBackpressure:!0,throttleMessage:0,throttleReconnect:0},t);let i,a,c,s,u,l=o.reconnectDelay,f=0,g=navigator.onLine,d=0,m="closed";const h=[],p=[],y=[];function b(...e){o.debug&&console.debug("[WS]",...e)}let S=null;function v(){y.length&&r.trigger("messageBatch",[y.splice(0)]),S=null}function w(){clearTimeout(s),s=setTimeout((()=>{b("Inactivity timeout reached. Closing socket."),A()}),o.inactivityTimeout)}function T(){m="connecting",g?(r.trigger("connecting"),b("Connecting",n),i=o.protocols?new WebSocket(n,o.protocols):new WebSocket(n),i.binaryType="arraybuffer",c=setTimeout((()=>{b("Connection timeout"),i.close(),r.trigger("error",[new Error("Connection timeout")]),x()}),o.connectionTimeout),i.onopen=e=>{m="open",clearTimeout(c),f=0,l=o.reconnectDelay,r.trigger("open",[e]),o.heartbeatInterval&&o.heartbeatMessage&&(a=setInterval((()=>{1===i.readyState&&(i.send(o.heartbeatMessage),b("Heartbeat sent"))}),o.heartbeatInterval)),function(){if(1!==i.readyState)return;const e=Date.now();for(const t of[h,p])for(;t.length;){if(e-d<o.rateLimitInterval)return;if(i.bufferedAmount>1048576)return void b("Backpressure detected, pause sending");if(t.length>o.maxQueueSize){b("Queue size too large, dropping message"),t.shift();continue}const n=t.shift();i.send(n),d=Date.now(),b("Sent queued message")}}(),w()},i.onmessage=e=>{if(w(),"ping"===e.data)return i.send("pong"),void b("Auto pong sent");"pong"!==e.data?function(e){if(e instanceof Blob||e instanceof ArrayBuffer){const t=new FileReader;return t.onload=()=>{let e=t.result;if(!o.disableAutoJson)try{e=JSON.parse(e)}catch{}r.trigger("binaryMessage",[e]),y.push(e),S||(S=setTimeout(v,o.batchInterval))},void(e instanceof Blob?t.readAsText(e):t.readAsText(new Blob([e])))}const t=function(e){if(o.customDeserialize)try{return o.customDeserialize(e)}catch{}if(o.disableAutoJson)return e;if("string"==typeof e)try{return JSON.parse(e)}catch{}return e}(e);y.push(t),S||(S=setTimeout(v,o.batchInterval))}(e.data):b("Pong received")},i.onclose=e=>{m="closed",clearTimeout(c),clearTimeout(s),r.trigger("close",[e]),Q(),o.reconnect&&x()},i.onerror=e=>{clearTimeout(c),r.trigger("error",[e])}):b("Offline, skipping connect")}function Q(){clearInterval(a),a=null}function x(){if(f>=o.maxRetries)return m="reconnecting",void b("Max reconnect retries reached");f++,l=Math.min(l*o.reconnectBackoffFactor,o.maxReconnectDelay);const e=l*o.reconnectJitter*Math.random(),t=l+e;b(`Reconnect attempt ${f} in ${t.toFixed(0)}ms`),setTimeout(T,t),r.trigger("reconnecting",[f])}function A(){clearTimeout(c),clearTimeout(s),Q(),!i||0!==i.readyState&&1!==i.readyState||i.close()}return window.addEventListener("online",(()=>{g=!0,b("Network online"),i&&1===i.readyState||o.reconnect&&x()})),window.addEventListener("offline",(()=>{g=!1,b("Network offline")})),T(),r.extend({send:function(e,t="normal"){const n="high"===t?h:p;if(e instanceof ArrayBuffer||e instanceof Blob||(e=function(e){if(o.customSerialize)try{return o.customSerialize(e)}catch{}if(o.disableAutoJson)return e;if(!(e instanceof ArrayBuffer||e instanceof Blob))try{return JSON.stringify(e)}catch{}return e}(e)),1===i.readyState&&i.bufferedAmount<1048576){const a=Date.now();if(a-d>=o.rateLimitInterval)i.send(e),d=a,b("Sent message"),clearTimeout(u),u=setTimeout((()=>{b("Send timeout occurred"),r.trigger("error",[new Error("Send timeout")])}),o.sendTimeout);else{if(n.length>=o.maxQueueSize)return b("Queue full, dropping message"),r.trigger("queueOverflow",[t]),!1;n.push(e),b(`Queued message (${t} priority, rate limit)`)}}else{if(n.length>=o.maxQueueSize)return b("Queue full, dropping message"),r.trigger("queueOverflow",[t]),!1;n.push(e),b(`Queued message (${t} priority, socket not ready)`)}return!0},close:A,isOpen:()=>i&&1===i.readyState,on(e,t){return r.on(e,t),this},off(e,t){return r.off(e,t),this},once(e,t){const n=(...o)=>{t.apply(this,o),r.off(e,n)};return r.on(e,n),this},status:()=>m,getStats:()=>({retryCount:f,highPriorityQueueLength:h.length,normalQueueLength:p.length,bufferedAmount:i?i.bufferedAmount:0}),getQueueSizes:()=>({highPriority:h.length,normal:p.length,maxQueueSize:o.maxQueueSize}),onReconnect(e){return r.on("reconnecting",e),this}})}const o=function(n,...o){return"string"==typeof n&&t.test(n)?r(n,o[0]||{}):e.apply(this,[n,...o])};Object.assign(o,e),o.wsPool=function(e,t,o){return n[e]||(n[e]=r(t,o)),n[e]},window.$=window.jQuery=o}(jQuery);
